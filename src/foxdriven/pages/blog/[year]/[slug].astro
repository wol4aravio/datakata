---
import { readItems, refresh } from "@directus/sdk";
import { getArticles } from "@foxdriven/scripts/directus";
import { unified } from "unified";
import rehypeMathjax from "rehype-mathjax";
import remarkMath from "remark-math";
import remarkRehype from "remark-rehype";
import rehypeStringify from "rehype-stringify";
import remarkParse from "remark-parse";
import rehypeKatex from "rehype-katex";

import ArticleLayout from "@foxdriven/layouts/ArticleLayout.astro";
import isProd from "@common/scripts/tools";

const { year, slug } = Astro.params;

const articles = await getArticles(isProd(Astro.url.toString()));
const article = articles.filter((a) => {
  // console.log(a.slug, a.slug == slug);
  return a.year == year && a.slug == slug;
})[0];

export async function getStaticPaths() {
  return [
    ...articles.map((a) => {
      return { params: { year: a.year, slug: a.slug } };
    }),
  ];
}

const content = await unified()
  .use(remarkParse)
  .use(remarkMath)
  .use(remarkRehype)
  .use(rehypeMathjax)
  .use(rehypeKatex)
  .use(rehypeStringify)
  .process(article.body);
---

<ArticleLayout title={article.title} description={article.description}>
  <article set:html={String(content)} />
</ArticleLayout>
